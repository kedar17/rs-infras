name: Laravel CI/CD (GoDaddy Subdomain)

on:
  push:
    branches:
      - admin

env:
  RELEASE_DIR: release

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Optional: enable PHP + composer on runner if you want to build vendor or run tests here
    # Uncomment these steps if you need composer install / asset build in CI
    #- name: Set up PHP
    #  uses: shivammathur/setup-php@v2
    #  with:
    #    php-version: '8.2'
    #    extensions: mbstring, bcmath, curl, xml, gd
    #    tools: composer
    #
    #- name: Install Composer dependencies
    #  run: composer install --no-dev --optimize-autoloader --no-interaction --no-progress

    - name: Prepare release folder
      run: |
        rm -rf $RELEASE_DIR || true
        mkdir -p $RELEASE_DIR
        rsync -av --exclude='.git' --exclude='.github' --exclude='node_modules' --exclude='tests' --exclude='.env' --exclude='storage/logs' ./ $RELEASE_DIR/

    - name: Add remote host key to known_hosts
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        if [ -z "${{ secrets.SSH_PORT }}" ]; then
          ssh-keyscan -H "${{ secrets.CPANEL_HOST }}" >> ~/.ssh/known_hosts
        else
          ssh-keyscan -H -p "${{ secrets.SSH_PORT }}" "${{ secrets.CPANEL_HOST }}" >> ~/.ssh/known_hosts
        fi
        chmod 644 ~/.ssh/known_hosts
      env:
        LC_ALL: C.UTF-8
        LANG: C.UTF-8

    - name: Install lftp
      run: |
        sudo apt-get update -y
        sudo apt-get install -y lftp

    - name: Deploy with lftp incremental upload
      run: |
        # choose protocol: default to sftp, allow override via SFTP_PROTOCOL secret (ftp | ftps | sftp)
        if [ -z "${{ secrets.SFTP_PROTOCOL }}" ] || [ "${{ secrets.SFTP_PROTOCOL }}" = "sftp" ]; then
          PROTO="sftp"
        else
          PROTO="${{ secrets.SFTP_PROTOCOL }}"
        fi

        # build TARGET_HOST; include port only when SSH_PORT is set
        if [ -z "${{ secrets.SSH_PORT }}" ]; then
          TARGET_HOST="${PROTO}://${{ secrets.CPANEL_HOST }}"
        else
          TARGET_HOST="${PROTO}://${{ secrets.CPANEL_HOST }}:${{ secrets.SSH_PORT }}"
        fi

        # run lftp mirror upload: --only-newer uploads changed/new files and preserves relative paths
        # tune --parallel and add --delete if you want remote deletions to mirror local
        lftp -u "${{ secrets.CPANEL_FTP_USER }}","${{ secrets.CPANEL_FTP_PASS }}" \
          -e "set ssl:verify-certificate no; \
              set sftp:connect-program 'ssh -a -x -o UserKnownHostsFile=~/.ssh/known_hosts -o StrictHostKeyChecking=yes'; \
              mirror -R --only-newer --parallel=3 --verbose ${RELEASE_DIR} ${{ secrets.REMOTE_DIR }}; bye" "$TARGET_HOST"
      env:
        LC_ALL: C.UTF-8
        LANG: C.UTF-8