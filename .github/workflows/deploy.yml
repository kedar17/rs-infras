name: Laravel CI/CD (GoDaddy Subdomain)

on:
  push:
    branches:
      - admin

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ⬇️ Checkout code
      uses: actions/checkout@v4


    - name: 🚫 Prepare release folder (exclude large/unwanted files)
		run: |
			rm -rf release || true
			mkdir -p release
			rsync -av --exclude='.git' --exclude='vendor' --exclude='.github' --exclude='node_modules' --exclude='tests' --exclude='.env' --exclude='storage/logs' ./ release/
    - name: Add host key to known_hosts
		run: |
			mkdir -p ~/.ssh
			chmod 700 ~/.ssh
			# use port if non-standard, e.g., -p 2222
			ssh-keyscan -H -p 22 "${{ secrets.CPANEL_HOST }}" >> ~/.ssh/known_hosts
			chmod 644 ~/.ssh/known_hosts
  env:
    LC_ALL: C.UTF-8
    LANG: C.UTF-8
    - name: 📡 Install lftp and deploy (incremental)
      run: |
        sudo apt-get update -y
        sudo apt-get install -y lftp
        # Choose protocol: sftp or ftp. Use sftp:// if your host supports SFTP.
        # For plain FTP use ftp://${{ secrets.CPANEL_HOST }} or just ${COPANEL_HOST} in the open command.
        lftp -u "${{ secrets.CPANEL_FTP_USER }}","${{ secrets.CPANEL_FTP_PASS }}" \
          -e "set ssl:verify-certificate no; \
               set ftp:ssl-allow no; \
               set net:max-retries 3; \
               set net:reconnect-interval-base 5; \
               mirror -R --only-newer --parallel=3 --verbose release ${{ secrets.REMOTE_DIR }}; \
               bye" sftp://${{ secrets.CPANEL_HOST }}
      env:
        LC_ALL: C.UTF-8
        LANG: C.UTF-8