name: Laravel CI/CD (GoDaddy Subdomain)

on:
  push:
    branches:
      - admin

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      # adjust if you need a different local source path
      LOCAL_SRC: ./

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Restore file mtimes from Git history
      uses: chetan/git-restore-mtime-action@v2

    # Optional PHP / Composer build steps (uncomment if needed)
    # - name: Set up PHP
    #   uses: shivammathur/setup-php@v2
    #   with:
    #     php-version: '8.2'
    #     extensions: mbstring, bcmath, curl, xml, gd
    #     tools: composer
    #
    # - name: Install Composer dependencies
    #   run: composer install --no-dev --optimize-autoloader --no-interaction --no-progress

    - name: Add remote host key to known_hosts
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        if [ -z "${{ secrets.SSH_PORT }}" ]; then
          ssh-keyscan -H "${{ secrets.CPANEL_HOST }}" >> ~/.ssh/known_hosts
        else
          ssh-keyscan -H -p "${{ secrets.SSH_PORT }}" "${{ secrets.CPANEL_HOST }}" >> ~/.ssh/known_hosts
        fi
        chmod 644 ~/.ssh/known_hosts
      env:
        LC_ALL: C.UTF-8
        LANG: C.UTF-8

    - name: Install lftp
      run: |
        sudo apt-get update -y
        sudo apt-get install -y lftp

    - name: Deploy directly from repo root with lftp (incremental, correct excludes)
  run: |
    if [ -z "${{ secrets.SFTP_PROTOCOL }}" ] || [ "${{ secrets.SFTP_PROTOCOL }}" = "sftp" ]; then
      PROTO="sftp"
    else
      PROTO="${{ secrets.SFTP_PROTOCOL }}"
    fi

    if [ -z "${{ secrets.SSH_PORT }}" ]; then
      TARGET_HOST="${PROTO}://${{ secrets.CPANEL_HOST }}"
    else
      TARGET_HOST="${PROTO}://${{ secrets.CPANEL_HOST }}:${{ secrets.SSH_PORT }}"
    fi

    # run lftp, cd to remote dir and mirror from local '.' so path matching is consistent
    lftp -u "${{ secrets.CPANEL_FTP_USER }}","${{ secrets.CPANEL_FTP_PASS }}" \
      -e "set ssl:verify-certificate no; \
          set sftp:connect-program 'ssh -a -x -o UserKnownHostsFile=~/.ssh/known_hosts -o StrictHostKeyChecking=yes'; \
          lcd .; \
          cd ${{ secrets.REMOTE_DIR }}; \
          mirror -R --only-newer --parallel=3 --verbose \
            --exclude .git/ \
            --exclude .github/ \
            --exclude node_modules/ \
            --exclude tests/ \
            --exclude .env \
            --exclude 'storage/logs/*' \
            . .; \
          bye" "$TARGET_HOST"
  env:
    LC_ALL: C.UTF-8
    LANG: C.UTF-8